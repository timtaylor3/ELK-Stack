# SOF-ELK Configuration File
# (C)2016 Lewes Technology Consulting, LLC
#
# This file contains transforms and enrichments to be applied in postprocessing
# Modifed by Tim Taylor to handle IPv6 and the new maxmind db format.
# Pointing to the GeoLite2-ASN.mmdb has not been tested

filter {
  if [source_ip] == "-" or [source_ip] == " " or [source_ip] == "" { 
    mutate { 
      replace => { "source_ip" => "0.0.0.0" } 
    } 
  }

  if [client_ip] { 
    mutate {
     add_field => [ "source_ip", "%{client_ip}" ]
     remove_field => [ "client_ip" ]
    } 
  }

  if [source_ip] { 
    geoip {
      database => "/usr/local/share/GeoIP/GeoLite2-ASN.mmdb"	
      source => "[source_ip]"
      target => "[source_geo]"
    }

    mutate {
     add_field => [ "ips", "%{source_ip}" ]
    } 
  }

  if [destination_ip] {
    geoip {
      database => "/usr/local/share/GeoIP/GeoLite2-ASN.mmdb"	
      source => "[destination_ip]"
      target => "[destination_geo]"
    }
    mutate {
     add_field => [ "ips", "%{destination_ip}" ]
    } 
  }

  if [ips] {
    geoip {
      database => "/usr/local/share/GeoIP/GeoLite2-ASN.mmdb"
      source => "[ips]"
      target => "[ips_geo]"
    }
  }

  if [answer_ip] {
    geoip {
      database => "/usr/local/share/GeoIP/GeoLite2-ASN.mmdb"
      source => "[answer_ip]"
      target => "[answer_geo]"
    }
    mutate {
     add_field => [ "ips", "%{answer_ip}" ]
    } 
  }
}
