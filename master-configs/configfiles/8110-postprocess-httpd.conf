# SOF-ELK Configuration File
# (C)2017 Lewes Technology Consulting, LLC
#
# This file contains postprocessing for HTTPD access log messages
#
# Updates by Tim Taylor
# Change the grok-patterns directory
# Updated logic to use tags since type was no longer determined by configuration.  
filter {
  if "httpdlog" in [tags] {
    # enrich the useragent field
    if [agent] {
      mutate {
        # remove quotes from quoted string
        # convert + sign to space
        gsub => [
          "agent", "\"", "",
          "agent", "\+", " "
        ]
      }
      useragent {
        source => [agent]
        target => [agentinfo]
      }
    }

    # look at %{request} and see if it ends in a "not page resource" extension. Issue #25.
    if [request] {
      grok {
        patterns_dir => "/usr/local/elk/grok-patterns"
        match => [ "request", "%{URIPATH:requestpath}" ]
        add_tag => [ "find_pagenotpage" ]
      }
      if "find_pagenotpage" in [tags] {
        grok {
          match => [ "requestpath", "\.(css|js|class|gif|jpg|jpeg|png|bmp|ico|rss|xml|swf)$" ]
          add_tag => [ "not_page" ]
          tag_on_failure => [ "page" ]
        }
        mutate {
          remove_field => [ "requestpath" ]
          remove_tag => [ "find_pagenotpage" ]
        }
      }
    }
  }
}
